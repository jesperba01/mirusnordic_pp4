{% extends "base.html" %}
{% block title %}Bookings{% endblock %}

{% block content %}
<div>
  <h2>Book a Treatment</h2>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}  {# Render the form fields in the template #}
    <input type="submit" value="Book">
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<script>
  $(document).ready(function() {
    // Get the current date
    var today = new Date();

    // Get the list of booked dates from the server
    var bookedDates = [
      {% for booking in bookings %}
        new Date("{{ booking.date|date:'Y-m-d' }}"),
      {% endfor %}
    ];

    $('.datepicker').datepicker({
      format: 'yyyy-mm-dd',
      beforeShowDay: function(date) {
        // Extract year, month, and day components of the date
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var day = date.getDate();

        // Format date as 'YYYY-MM-DD'
        var dateString = year + '-' + ('0' + month).slice(-2) + '-' + ('0' + day).slice(-2);

        // Check if the date is in the bookedDates list
        var isBooked = bookedDates.some(function(bookedDate) {
          var bookedYear = bookedDate.getFullYear();
          var bookedMonth = bookedDate.getMonth() + 1;
          var bookedDay = bookedDate.getDate();
          var bookedDateString = bookedYear + '-' + ('0' + bookedMonth).slice(-2) + '-' + ('0' + bookedDay).slice(-2);
          return bookedDateString === dateString;
        });

        var isPassed = date < today;

        return {
          enabled: !isBooked && !isPassed,  // Enable only if not booked and not passed
        };
      }
    });
  });
</script>

{% endblock %}